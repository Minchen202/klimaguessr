import time
import flask
from flask import request, jsonify, render_template, send_from_directory
from flask_socketio import SocketIO, emit, join_room
import random
import uuid
import string
from werkzeug.security import generate_password_hash, check_password_hash
import threading
import math
from database import db
from config import Config
import db_models
from datetime import datetime

app = flask.Flask(__name__)
app.config['SECRET_KEY'] = 'd711deff-6edd-4364-933b-62d7702806cc'

app.config.from_object(Config)
db.init_app(app)

with app.app_context():
    db.create_all()

socketio = SocketIO(app)

active_lobbies = {}
active_solo_games = {}



climateData = [
              {
                "name": "London, UK",
                "lat": 51.5074,
                "lng": -0.1278,
                "temp": [4, 5, 7, 10, 14, 17, 19, 19, 16, 12, 7, 5],
                "precip": [55, 40, 42, 44, 49, 45, 57, 59, 49, 69, 59, 55]
              },
              {
                "name": "Paris, France",
                "lat": 48.8566,
                "lng": 2.3522,
                "temp": [4, 5, 8, 11, 15, 18, 20, 20, 17, 13, 8, 5],
                "precip": [53, 46, 51, 51, 62, 53, 56, 52, 54, 60, 56, 57]
              },
              {
                "name": "Berlin, Germany",
                "lat": 52.5200,
                "lng": 13.4050,
                "temp": [0, 1, 5, 9, 14, 17, 19, 19, 15, 10, 5, 2],
                "precip": [42, 35, 37, 37, 47, 59, 69, 61, 49, 40, 45, 46]
              },
              {
                "name": "Rome, Italy",
                "lat": 41.9028,
                "lng": 12.4964,
                "temp": [8, 9, 11, 14, 18, 22, 25, 25, 22, 17, 12, 9],
                "precip": [70, 75, 60, 50, 30, 20, 10, 20, 60, 100, 120, 90]
              },
              {
                "name": "Moscow, Russia",
                "lat": 55.7558,
                "lng": 37.6173,
                "temp": [-6, -6, -1, 6, 13, 17, 19, 17, 11, 5, -1, -5],
                "precip": [52, 41, 35, 37, 51, 75, 85, 78, 67, 60, 55, 53]
              },
              {
                "name": "Reykjavik, Iceland",
                "lat": 64.9631,
                "lng": -19.0208,
                "temp": [0, 0, 1, 3, 7, 10, 12, 11, 8, 4, 1, 0],
                "precip": [80, 75, 70, 60, 50, 45, 50, 60, 70, 80, 85, 80]
              },
              {
                "name": "New York City, USA",
                "lat": 40.7128,
                "lng": -74.0060,
                "temp": [0, 1, 6, 12, 18, 23, 26, 25, 21, 14, 8, 3],
                "precip": [80, 75, 90, 95, 90, 85, 110, 105, 95, 90, 90, 85]
              },
              {
                "name": "Los Angeles, USA",
                "lat": 34.0522,
                "lng": -118.2437,
                "temp": [14, 15, 15, 17, 19, 21, 23, 24, 23, 20, 17, 14],
                "precip": [79, 81, 60, 20, 7, 2, 0, 1, 7, 10, 30, 50]
              },
              {
                "name": "Miami, USA",
                "lat": 25.7617,
                "lng": -80.1918,
                "temp": [20, 21, 22, 24, 26, 28, 28, 28, 27, 26, 23, 21],
                "precip": [50, 55, 60, 70, 150, 240, 190, 220, 250, 180, 70, 50]
              },
              {
                "name": "Vancouver, Canada",
                "lat": 49.2827,
                "lng": -123.1207,
                "temp": [3, 4, 6, 9, 13, 16, 18, 18, 15, 10, 6, 3],
                "precip": [140, 110, 100, 70, 60, 50, 40, 50, 70, 120, 150, 160]
              },
              {
                "name": "Mexico City, Mexico",
                "lat": 19.4326,
                "lng": -99.1332,
                "temp": [13, 14, 17, 18, 19, 18, 17, 17, 17, 16, 15, 14],
                "precip": [10, 10, 10, 30, 70, 150, 170, 160, 120, 40, 10, 10]
              },
              {
                "name": "Rio de Janeiro, Brazil",
                "lat": -22.9068,
                "lng": -43.1729,
                "temp": [26, 26, 25, 24, 22, 21, 21, 22, 22, 23, 24, 25],
                "precip": [130, 110, 130, 100, 70, 50, 40, 40, 70, 90, 100, 130]
              },
              {
                "name": "Buenos Aires, Argentina",
                "lat": -34.6037,
                "lng": -58.3816,
                "temp": [24, 23, 21, 17, 14, 11, 11, 12, 14, 17, 20, 22],
                "precip": [120, 120, 140, 100, 80, 50, 50, 60, 70, 120, 120, 120]
              },
              {
                "name": "Santiago, Chile",
                "lat": -33.4489,
                "lng": -70.6693,
                "temp": [20, 19, 17, 13, 10, 8, 7, 9, 11, 14, 17, 19],
                "precip": [0, 0, 0, 10, 50, 70, 80, 40, 20, 10, 0, 0]
              },
              {
                "name": "Lima, Peru",
                "lat": -12.0464,
                "lng": -77.0428,
                "temp": [23, 24, 24, 22, 20, 18, 17, 17, 18, 19, 20, 22],
                "precip": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
              },
              {
                "name": "Cairo, Egypt",
                "lat": 30.0444,
                "lng": 31.2357,
                "temp": [14, 16, 19, 23, 27, 29, 30, 30, 28, 25, 20, 16],
                "precip": [5, 3, 2, 1, 0, 0, 0, 0, 0, 1, 3, 5]
              },
              {
                "name": "Nairobi, Kenya",
                "lat": -1.2921,
                "lng": 36.8219,
                "temp": [19, 20, 21, 21, 20, 19, 18, 18, 19, 20, 20, 19],
                "precip": [60, 50, 100, 200, 150, 50, 20, 20, 30, 60, 120, 90]
              },
              {
                "name": "Cape Town, South Africa",
                "lat": -33.9249,
                "lng": 18.4241,
                "temp": [21, 21, 20, 18, 16, 14, 13, 14, 15, 17, 19, 20],
                "precip": [15, 17, 20, 40, 70, 90, 80, 60, 40, 30, 20, 15]
              },
              {
                "name": "Marrakech, Morocco",
                "lat": 31.6295,
                "lng": -7.9813,
                "temp": [12, 14, 17, 20, 23, 27, 30, 30, 27, 23, 17, 13],
                "precip": [30, 30, 20, 10, 5, 2, 0, 0, 5, 20, 30, 30]
              },
              {
                "name": "Tokyo, Japan",
                "lat": 35.6895,
                "lng": 139.6917,
                "temp": [6, 6, 9, 14, 18, 21, 25, 26, 23, 18, 13, 9],
                "precip": [50, 60, 110, 120, 130, 160, 150, 170, 210, 190, 90, 50]
              },
              {
                "name": "Beijing, China",
                "lat": 39.9042,
                "lng": 116.4074,
                "temp": [-4, -1, 6, 14, 20, 24, 26, 25, 20, 13, 4, -2],
                "precip": [3, 5, 8, 20, 35, 70, 180, 150, 50, 20, 8, 3]
              },
              {
                "name": "Mumbai, India",
                "lat": 19.0760,
                "lng": 72.8777,
                "temp": [25, 26, 28, 30, 30, 28, 27, 27, 27, 28, 27, 26],
                "precip": [0, 0, 0, 0, 20, 500, 700, 400, 200, 50, 10, 0]
              },
              {
                "name": "Singapore, Singapore",
                "lat": 1.3521,
                "lng": 103.8198,
                "temp": [27, 27, 28, 28, 28, 28, 28, 28, 27, 27, 27, 27],
                "precip": [240, 160, 180, 170, 170, 160, 160, 170, 170, 190, 250, 330]
              },
              {
                "name": "Dubai, UAE",
                "lat": 25.276987,
                "lng": 55.296249,
                "temp": [20, 21, 24, 28, 32, 34, 35, 35, 33, 30, 25, 22],
                "precip": [10, 10, 10, 5, 0, 0, 0, 0, 0, 0, 5, 10]
              },
              {
                "name": "Sydney, Australia",
                "lat": -33.8688,
                "lng": 151.2093,
                "temp": [23, 23, 21, 18, 15, 13, 12, 13, 16, 18, 20, 22],
                "precip": [100, 120, 130, 120, 120, 120, 100, 80, 70, 80, 90, 90]
              },
              {
                "name": "Auckland, New Zealand",
                "lat": -36.8485,
                "lng": 174.7633,
                "temp": [19, 19, 18, 15, 13, 11, 10, 11, 12, 14, 16, 18],
                "precip": [70, 60, 80, 90, 110, 120, 130, 120, 100, 90, 80, 70]
              },
              {
                "name": "Nuuk, Greenland",
                "lat": 64.1835,
                "lng": -51.7216,
                "temp": [-8, -9, -8, -3, 2, 6, 8, 7, 4, -1, -4, -7],
                "precip": [70, 60, 70, 60, 60, 60, 70, 70, 80, 70, 80, 80]
              },
              {
                "name": "Yakutsk, Russia",
                "lat": 62.0397,
                "lng": 129.7331,
                "temp": [-39, -35, -22, -8, 5, 15, 19, 15, 6, -6, -24, -36],
                "precip": [10, 8, 7, 10, 20, 30, 40, 30, 20, 15, 12, 10]
              },
              {
                "name": "Helsinki, Finland",
                "lat": 60.1699,
                "lng": 24.9384,
                "temp": [-5, -6, -2, 4, 10, 15, 18, 16, 11, 6, 1, -2],
                "precip": [50, 40, 40, 30, 40, 60, 60, 70, 60, 60, 60, 60]
              },
              {
                "name": "Oslo, Norway",
                "lat": 59.9139,
                "lng": 10.7522,
                "temp": [-3, -3, 0, 5, 11, 15, 17, 16, 12, 7, 2, -1],
                "precip": [50, 40, 40, 40, 50, 70, 80, 90, 80, 80, 70, 60]
              },
              {
                "name": "Stockholm, Sweden",
                "lat": 59.3293,
                "lng": 18.0686,
                "temp": [-3, -3, 0, 5, 11, 15, 18, 17, 12, 7, 2, -1],
                "precip": [40, 30, 30, 30, 40, 50, 60, 60, 50, 50, 50, 50]
              },
              {
                "name": "Warsaw, Poland",
                "lat": 52.2297,
                "lng": 21.0122,
                "temp": [-2, 0, 4, 9, 15, 18, 20, 19, 14, 9, 4, 0],
                "precip": [30, 30, 30, 40, 50, 70, 80, 70, 50, 40, 40, 40]
              },
              {
                "name": "Prague, Czech Republic",
                "lat": 50.0755,
                "lng": 14.4378,
                "temp": [-1, 0, 4, 9, 14, 18, 20, 19, 14, 9, 4, 0],
                "precip": [20, 20, 20, 30, 40, 50, 60, 50, 40, 30, 30, 30]
              },
              {
                "name": "Vienna, Austria",
                "lat": 48.2082,
                "lng": 16.3738,
                "temp": [0, 1, 6, 11, 16, 19, 21, 20, 15, 10, 5, 1],
                "precip": [30, 30, 40, 40, 60, 70, 70, 70, 50, 40, 40, 30]
              },
              {
                "name": "Budapest, Hungary",
                "lat": 47.4979,
                "lng": 19.0402,
                "temp": [0, 2, 6, 12, 17, 20, 22, 21, 16, 11, 5, 1],
                "precip": [30, 30, 30, 40, 60, 70, 60, 60, 50, 40, 40, 30]
              },
              {
                "name": "Lisbon, Portugal",
                "lat": 38.7223,
                "lng": -9.1393,
                "temp": [11, 12, 14, 16, 18, 21, 23, 24, 22, 19, 15, 12],
                "precip": [100, 80, 60, 50, 40, 20, 10, 10, 40, 80, 100, 100]
              },
              {
                "name": "Madrid, Spain",
                "lat": 40.4168,
                "lng": -3.7038,
                "temp": [6, 7, 10, 13, 17, 22, 25, 25, 21, 15, 10, 7],
                "precip": [40, 30, 30, 40, 40, 20, 10, 10, 30, 50, 60, 50]
              },
              {
                "name": "Athens, Greece",
                "lat": 37.9838,
                "lng": 23.7275,
                "temp": [10, 10, 12, 16, 20, 24, 27, 27, 23, 19, 15, 12],
                "precip": [60, 40, 40, 20, 10, 5, 5, 5, 10, 40, 60, 70]
              },
              {
                "name": "Istanbul, Turkey",
                "lat": 41.0082,
                "lng": 28.9784,
                "temp": [6, 6, 8, 13, 17, 22, 24, 24, 20, 16, 12, 8],
                "precip": [90, 70, 60, 40, 30, 30, 20, 30, 50, 80, 90, 100]
              },
              {
                "name": "Jerusalem, Israel",
                "lat": 31.7683,
                "lng": 35.2137,
                "temp": [9, 10, 12, 16, 20, 23, 25, 25, 23, 20, 15, 11],
                "precip": [100, 80, 70, 20, 5, 0, 0, 0, 0, 20, 50, 90]
              },
              {
                "name": "Tehran, Iran",
                "lat": 35.6892,
                "lng": 51.3890,
                "temp": [2, 5, 11, 18, 23, 28, 30, 29, 25, 18, 11, 5],
                "precip": [40, 40, 40, 30, 10, 0, 0, 0, 0, 10, 20, 30]
              },
              {
                "name": "Baghdad, Iraq",
                "lat": 33.3152,
                "lng": 44.3661,
                "temp": [10, 13, 18, 24, 30, 34, 37, 37, 33, 27, 19, 12],
                "precip": [20, 20, 20, 10, 5, 0, 0, 0, 0, 5, 10, 20]
              },
              {
                "name": "Kabul, Afghanistan",
                "lat": 34.5553,
                "lng": 69.2075,
                "temp": [-2, 0, 7, 14, 19, 23, 25, 24, 20, 14, 7, 2],
                "precip": [30, 50, 70, 60, 20, 5, 0, 0, 0, 10, 20, 30]
              },
              {
                "name": "New Delhi, India",
                "lat": 28.6139,
                "lng": 77.2090,
                "temp": [14, 17, 22, 28, 33, 33, 30, 29, 28, 25, 20, 16],
                "precip": [20, 20, 15, 10, 20, 90, 250, 200, 100, 20, 5, 5]
              },
              {
                "name": "Bangkok, Thailand",
                "lat": 13.7563,
                "lng": 100.5018,
                "temp": [26, 28, 29, 30, 29, 29, 28, 28, 28, 28, 27, 26],
                "precip": [20, 30, 40, 90, 220, 150, 150, 190, 250, 220, 50, 20]
              },
              {
                "name": "Hanoi, Vietnam",
                "lat": 21.0278,
                "lng": 105.8342,
                "temp": [17, 18, 21, 24, 27, 28, 28, 28, 27, 25, 21, 18],
                "precip": [20, 30, 40, 90, 200, 250, 280, 300, 250, 100, 50, 20]
              },
              {
                "name": "Jakarta, Indonesia",
                "lat": -6.2088,
                "lng": 106.8456,
                "temp": [27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27],
                "precip": [300, 250, 150, 100, 100, 80, 60, 60, 80, 100, 150, 200]
              },
              {
                "name": "Manila, Philippines",
                "lat": 14.5995,
                "lng": 120.9842,
                "temp": [26, 27, 28, 29, 29, 28, 27, 27, 27, 27, 27, 26],
                "precip": [20, 10, 20, 40, 150, 250, 400, 400, 300, 200, 100, 50]
              },
              {
                "name": "Kuala Lumpur, Malaysia",
                "lat": 3.1390,
                "lng": 101.6869,
                "temp": [27, 27, 28, 28, 28, 28, 27, 27, 27, 27, 27, 27],
                "precip": [160, 170, 200, 250, 200, 150, 150, 160, 190, 250, 260, 230]
              },
              {
                "name": "Perth, Australia",
                "lat": -31.9505,
                "lng": 115.8605,
                "temp": [25, 25, 23, 20, 17, 15, 14, 14, 15, 17, 20, 23],
                "precip": [10, 10, 10, 20, 60, 90, 100, 80, 50, 30, 20, 10]
              },
              {
                "name": "Adelaide, Australia",
                "lat": -34.9285,
                "lng": 138.6007,
                "temp": [23, 23, 21, 18, 15, 13, 12, 13, 15, 18, 20, 22],
                "precip": [20, 20, 20, 30, 50, 70, 70, 60, 50, 40, 30, 20]
              },
              {
                "name": "Hobart, Australia",
                "lat": -42.8821,
                "lng": 147.3272,
                "temp": [17, 17, 15, 13, 11, 9, 9, 10, 12, 14, 15, 16],
                "precip": [50, 40, 50, 50, 50, 60, 50, 50, 50, 50, 50, 50]
              },
              {
                "name": "Wellington, New Zealand",
                "lat": -41.2865,
                "lng": 174.7762,
                "temp": [18, 18, 17, 15, 13, 11, 10, 11, 13, 14, 16, 17],
                "precip": [70, 60, 80, 90, 120, 130, 140, 120, 100, 90, 80, 70]
              },
              {
                "name": "Honolulu, USA",
                "lat": 21.3099,
                "lng": -157.8583,
                "temp": [23, 23, 24, 25, 26, 27, 28, 28, 27, 26, 25, 24],
                "precip": [90, 60, 50, 30, 20, 10, 10, 10, 20, 40, 70, 90]
              },
              {
                "name": "Anchorage, USA",
                "lat": 61.2181,
                "lng": -149.9003,
                "temp": [-8, -6, -3, 2, 8, 12, 15, 14, 9, 1, -5, -8],
                "precip": [20, 20, 20, 15, 20, 30, 40, 50, 60, 50, 30, 30]
              },
              {
                "name": "Cairo, Egypt",
                "lat": 30.0444,
                "lng": 31.2357,
                "temp": [14, 16, 19, 23, 27, 29, 30, 30, 28, 25, 20, 16],
                "precip": [5, 3, 2, 1, 0, 0, 0, 0, 0, 1, 3, 5]
              },
              {
                "name": "Lagos, Nigeria",
                "lat": 6.5244,
                "lng": 3.3792,
                "temp": [28, 29, 29, 29, 28, 27, 26, 26, 26, 27, 28, 28],
                "precip": [30, 40, 80, 140, 250, 300, 250, 150, 200, 150, 50, 20]
              },
              {
                "name": "Johannesburg, South Africa",
                "lat": -26.2041,
                "lng": 28.0473,
                "temp": [20, 19, 18, 15, 12, 9, 9, 12, 15, 17, 18, 19],
                "precip": [100, 70, 70, 40, 10, 5, 5, 10, 20, 60, 90, 100]
              },
              {
                "name": "Casablanca, Morocco",
                "lat": 33.5731,
                "lng": -7.5898,
                "temp": [13, 14, 16, 17, 19, 22, 24, 25, 23, 20, 16, 14],
                "precip": [60, 50, 40, 30, 10, 5, 0, 0, 10, 40, 60, 70]
              },
              {
                "name": "Algiers, Algeria",
                "lat": 36.7538,
                "lng": 3.0588,
                "temp": [12, 13, 14, 17, 20, 24, 27, 28, 25, 21, 16, 13],
                "precip": [80, 70, 60, 40, 20, 10, 0, 0, 10, 40, 70, 90]
              },
              {
                "name": "Tunis, Tunisia",
                "lat": 36.8065,
                "lng": 10.1815,
                "temp": [12, 13, 15, 18, 22, 26, 29, 29, 26, 22, 17, 13],
                "precip": [60, 50, 40, 30, 20, 10, 0, 0, 10, 40, 60, 70]
              },
              {
                "name": "Dakar, Senegal",
                "lat": 14.7167,
                "lng": -17.4677,
                "temp": [22, 22, 23, 23, 24, 26, 28, 28, 28, 28, 26, 24],
                "precip": [0, 0, 0, 0, 0, 10, 100, 250, 250, 70, 10, 0]
              },
              {
                "name": "Accra, Ghana",
                "lat": 5.6037,
                "lng": -0.1870,
                "temp": [28, 28, 29, 29, 28, 26, 25, 25, 26, 27, 28, 28],
                "precip": [20, 40, 80, 100, 150, 200, 100, 50, 100, 100, 50, 20]
              },
              {
                "name": "Addis Ababa, Ethiopia",
                "lat": 9.0192,
                "lng": 38.7525,
                "temp": [20, 21, 22, 22, 22, 20, 19, 19, 20, 20, 20, 20],
                "precip": [20, 30, 60, 90, 90, 120, 200, 200, 100, 40, 20, 10]
              },
              {
                "name": "Kinshasa, DR Congo",
                "lat": -4.4419,
                "lng": 15.2663,
                "temp": [27, 27, 28, 28, 27, 26, 25, 26, 27, 27, 27, 27],
                "precip": [130, 140, 170, 180, 130, 50, 20, 50, 100, 150, 200, 150]
              },
              {
                "name": "Antananarivo, Madagascar",
                "lat": -18.8792,
                "lng": 47.5079,
                "temp": [21, 21, 20, 19, 17, 15, 14, 15, 17, 19, 20, 21],
                "precip": [250, 200, 150, 50, 20, 10, 10, 10, 20, 50, 100, 200]
              },
              {
                "name": "Toronto, Canada",
                "lat": 43.6532,
                "lng": -79.3832,
                "temp": [-4, -3, 2, 8, 14, 19, 22, 21, 17, 11, 5, -1],
                "precip": [60, 50, 60, 70, 70, 70, 80, 80, 80, 70, 80, 70]
              },
              {
                "name": "Chicago, USA",
                "lat": 41.8781,
                "lng": -87.6298,
                "temp": [-4, -2, 4, 10, 16, 22, 24, 23, 19, 12, 5, -1],
                "precip": [40, 40, 60, 80, 90, 100, 100, 90, 90, 70, 70, 50]
              },
              {
                "name": "Denver, USA",
                "lat": 39.7392,
                "lng": -104.9903,
                "temp": [0, 1, 5, 10, 15, 21, 24, 23, 18, 11, 4, 0],
                "precip": [10, 10, 20, 40, 50, 40, 40, 30, 20, 20, 10, 10]
              },
              {
                "name": "Houston, USA",
                "lat": 29.7604,
                "lng": -95.3698,
                "temp": [13, 15, 18, 22, 26, 29, 30, 30, 28, 23, 18, 15],
                "precip": [90, 80, 80, 70, 120, 150, 100, 100, 120, 100, 90, 90]
              },
              {
                "name": "Seattle, USA",
                "lat": 47.6062,
                "lng": -122.3321,
                "temp": [5, 6, 8, 11, 14, 17, 20, 20, 17, 12, 8, 5],
                "precip": [140, 100, 90, 60, 40, 30, 20, 30, 50, 100, 150, 150]
              },
              {
                "name": "San Francisco, USA",
                "lat": 37.7749,
                "lng": -122.4194,
                "temp": [10, 11, 12, 13, 14, 15, 16, 16, 17, 16, 13, 11],
                "precip": [100, 80, 70, 30, 10, 0, 0, 0, 10, 30, 70, 90]
              },
              {
                "name": "Boston, USA",
                "lat": 42.3601,
                "lng": -71.0589,
                "temp": [-1, 0, 4, 9, 15, 20, 23, 22, 18, 12, 7, 2],
                "precip": [90, 80, 100, 90, 90, 80, 80, 80, 80, 90, 100, 90]
              },
              {
                "name": "Washington D.C., USA",
                "lat": 38.9072,
                "lng": -77.0369,
                "temp": [2, 3, 8, 14, 19, 24, 27, 26, 22, 16, 10, 5],
                "precip": [80, 70, 90, 90, 90, 90, 100, 90, 90, 80, 80, 80]
              },
              {
                "name": "Atlanta, USA",
                "lat": 33.7490,
                "lng": -84.3880,
                "temp": [7, 9, 13, 18, 22, 26, 27, 27, 24, 18, 12, 8],
                "precip": [120, 110, 120, 90, 90, 100, 120, 100, 90, 80, 90, 100]
              },
              {
                "name": "New Orleans, USA",
                "lat": 29.9511,
                "lng": -90.0715,
                "temp": [13, 15, 18, 22, 26, 28, 28, 28, 26, 22, 18, 15],
                "precip": [120, 120, 110, 100, 120, 180, 150, 150, 120, 90, 100, 120]
              },
              {
                "name": "Phoenix, USA",
                "lat": 33.4484,
                "lng": -112.0740,
                "temp": [12, 14, 17, 22, 27, 32, 35, 34, 31, 24, 17, 13],
                "precip": [20, 20, 20, 10, 5, 2, 20, 20, 10, 10, 10, 20]
              },
              {
                "name": "Las Vegas, USA",
                "lat": 36.1699,
                "lng": -115.1398,
                "temp": [8, 11, 14, 19, 24, 29, 33, 32, 28, 21, 13, 8],
                "precip": [10, 10, 10, 5, 2, 0, 10, 10, 5, 5, 10, 10]
              },
              {
                "name": "Salt Lake City, USA",
                "lat": 40.7608,
                "lng": -111.8910,
                "temp": [0, 2, 6, 11, 16, 22, 26, 25, 19, 12, 5, 0],
                "precip": [30, 30, 40, 40, 40, 20, 10, 10, 20, 30, 30, 30]
              },
              {
                "name": "Dallas, USA",
                "lat": 32.7767,
                "lng": -96.7970,
                "temp": [8, 10, 14, 19, 24, 28, 30, 30, 26, 20, 14, 9],
                "precip": [60, 70, 80, 80, 120, 100, 70, 60, 80, 100, 80, 70]
              },
              {
                "name": "Orlando, USA",
                "lat": 28.5383,
                "lng": -81.3792,
                "temp": [16, 17, 20, 22, 25, 27, 28, 28, 27, 24, 20, 17],
                "precip": [60, 60, 80, 60, 90, 180, 190, 170, 150, 80, 60, 60]
              },
              {
                "name": "Denver, USA",
                "lat": 39.7392,
                "lng": -104.9903,
                "temp": [0, 1, 5, 10, 15, 21, 24, 23, 18, 11, 4, 0],
                "precip": [10, 10, 20, 40, 50, 40, 40, 30, 20, 20, 10, 10]
              },
              {
                "name": "Bogota, Colombia",
                "lat": 4.7110,
                "lng": -74.0721,
                "temp": [14, 14, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14],
                "precip": [60, 70, 90, 100, 100, 50, 40, 40, 70, 100, 90, 70]
              },
              {
                "name": "Quito, Ecuador",
                "lat": -0.1807,
                "lng": -78.4678,
                "temp": [14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14],
                "precip": [100, 120, 130, 150, 120, 50, 20, 20, 60, 100, 100, 90]
              },
              {
                "name": "La Paz, Bolivia",
                "lat": -16.4897,
                "lng": -68.1193,
                "temp": [10, 10, 10, 10, 9, 8, 8, 9, 9, 10, 10, 10],
                "precip": [130, 100, 80, 40, 10, 0, 0, 0, 10, 30, 60, 100]
              },
              {
                "name": "Caracas, Venezuela",
                "lat": 10.4806,
                "lng": -66.9036,
                "temp": [24, 24, 25, 25, 25, 24, 24, 24, 24, 24, 24, 24],
                "precip": [20, 10, 20, 40, 80, 120, 120, 120, 100, 80, 60, 40]
              },
              {
                "name": "Havana, Cuba",
                "lat": 23.1136,
                "lng": -82.3666,
                "temp": [22, 22, 24, 26, 27, 28, 28, 28, 27, 26, 24, 23],
                "precip": [60, 50, 50, 60, 100, 180, 150, 150, 180, 100, 60, 60]
              },
              {
                "name": "Kingston, Jamaica",
                "lat": 17.9900,
                "lng": -76.7900,
                "temp": [26, 26, 27, 27, 28, 28, 28, 28, 28, 27, 27, 26],
                "precip": [30, 30, 40, 50, 100, 120, 100, 100, 120, 150, 100, 50]
              },
              {
                "name": "Panama City, Panama",
                "lat": 8.9824,
                "lng": -79.5199,
                "temp": [27, 27, 28, 28, 28, 27, 27, 27, 27, 27, 27, 27],
                "precip": [30, 20, 30, 100, 200, 250, 200, 200, 250, 250, 150, 50]
              },
              {
                "name": "San Jose, Costa Rica",
                "lat": 9.9281,
                "lng": -84.0907,
                "temp": [22, 23, 24, 24, 23, 22, 22, 22, 22, 22, 22, 22],
                "precip": [10, 10, 30, 100, 250, 250, 200, 200, 250, 200, 100, 30]
              },
              {
                "name": "Dublin, Ireland",
                "lat": 53.3498,
                "lng": -6.2603,
                "temp": [5, 5, 7, 9, 12, 15, 17, 16, 14, 11, 7, 5],
                "precip": [70, 50, 50, 50, 50, 60, 60, 70, 70, 80, 80, 80]
              },
              {
                "name": "Edinburgh, Scotland",
                "lat": 55.9533,
                "lng": -3.1883,
                "temp": [4, 4, 6, 8, 11, 14, 16, 16, 13, 10, 6, 4],
                "precip": [60, 50, 50, 40, 50, 60, 60, 70, 70, 70, 70, 70]
              },
              {
                "name": "Cardiff, Wales",
                "lat": 51.4816,
                "lng": -3.1791,
                "temp": [5, 5, 7, 9, 12, 15, 17, 17, 15, 12, 8, 6],
                "precip": [100, 70, 70, 60, 60, 60, 70, 80, 80, 100, 100, 100]
              },
              {
                "name": "Belfast, Northern Ireland",
                "lat": 54.5973,
                "lng": -5.9301,
                "temp": [4, 4, 6, 8, 11, 14, 16, 16, 13, 10, 7, 5],
                "precip": [90, 70, 70, 60, 60, 70, 70, 80, 80, 90, 90, 90]
              },
              {
                "name": "Brussels, Belgium",
                "lat": 50.8503,
                "lng": 4.3517,
                "temp": [3, 3, 6, 9, 13, 16, 18, 18, 15, 11, 7, 4],
                "precip": [60, 50, 50, 50, 60, 70, 70, 70, 60, 60, 70, 70]
              },
              {
                "name": "Amsterdam, Netherlands",
                "lat": 52.3676,
                "lng": 4.9041,
                "temp": [3, 3, 6, 9, 13, 16, 18, 18, 15, 11, 7, 4],
                "precip": [60, 50, 50, 40, 50, 60, 70, 70, 60, 60, 70, 70]
              },
              {
                "name": "Copenhagen, Denmark",
                "lat": 55.6761,
                "lng": 12.5683,
                "temp": [0, 0, 3, 7, 12, 16, 18, 17, 13, 9, 4, 1],
                "precip": [40, 30, 30, 30, 40, 50, 60, 60, 50, 50, 50, 50]
              },
              {
                "name": "Zurich, Switzerland",
                "lat": 47.3769,
                "lng": 8.5417,
                "temp": [0, 1, 5, 9, 14, 17, 19, 19, 14, 9, 4, 1],
                "precip": [60, 60, 60, 70, 90, 100, 100, 100, 80, 70, 70, 70]
              },
              {
                "name": "Geneva, Switzerland",
                "lat": 46.2044,
                "lng": 6.1432,
                "temp": [2, 3, 6, 10, 14, 18, 20, 20, 16, 11, 6, 3],
                "precip": [60, 60, 60, 60, 70, 80, 80, 80, 70, 70, 70, 70]
              },
              {
                "name": "Munich, Germany",
                "lat": 48.1351,
                "lng": 11.5820,
                "temp": [-1, 0, 4, 8, 13, 16, 18, 18, 13, 8, 3, 0],
                "precip": [40, 40, 50, 50, 70, 90, 90, 90, 70, 50, 50, 40]
              },
              {
                "name": "Frankfurt, Germany",
                "lat": 50.1109,
                "lng": 8.6821,
                "temp": [1, 2, 6, 10, 15, 18, 20, 20, 16, 11, 6, 2],
                "precip": [40, 30, 40, 40, 60, 70, 70, 70, 50, 40, 40, 40]
              },
              {
                "name": "Hamburg, Germany",
                "lat": 53.5511,
                "lng": 10.0000,
                "temp": [1, 1, 4, 8, 13, 16, 18, 18, 14, 9, 5, 2],
                "precip": [60, 50, 50, 40, 50, 70, 70, 70, 60, 60, 60, 60]
              },
              {
                "name": "Marseille, France",
                "lat": 43.2965,
                "lng": 5.3698,
                "temp": [7, 8, 10, 13, 17, 21, 24, 24, 20, 16, 11, 8],
                "precip": [50, 40, 40, 30, 20, 10, 5, 10, 40, 70, 70, 60]
              },
              {
                "name": "Nice, France",
                "lat": 43.7102,
                "lng": 7.2620,
                "temp": [9, 9, 11, 14, 17, 21, 24, 24, 21, 17, 13, 10],
                "precip": [70, 50, 50, 40, 30, 20, 10, 20, 50, 80, 90, 80]
              },
              {
                "name": "Barcelona, Spain",
                "lat": 41.3851,
                "lng": 2.1734,
                "temp": [9, 10, 12, 15, 18, 22, 25, 26, 23, 19, 14, 10],
                "precip": [40, 30, 40, 40, 40, 30, 20, 30, 70, 90, 60, 50]
              },
              {
                "name": "Valencia, Spain",
                "lat": 39.4699,
                "lng": -0.3763,
                "temp": [12, 13, 15, 17, 20, 24, 27, 27, 24, 20, 15, 13],
                "precip": [40, 30, 30, 40, 30, 20, 10, 20, 50, 80, 60, 50]
              },
              {
                "name": "Seville, Spain",
                "lat": 37.3891,
                "lng": -5.9845,
                "temp": [11, 13, 16, 19, 23, 27, 30, 30, 27, 22, 16, 12],
                "precip": [60, 50, 40, 40, 20, 10, 0, 0, 20, 60, 80, 90]
              },
              {
                "name": "Porto, Portugal",
                "lat": 41.1579,
                "lng": -8.6291,
                "temp": [9, 10, 11, 13, 15, 18, 20, 20, 19, 16, 12, 10],
                "precip": [130, 110, 100, 90, 80, 40, 20, 30, 70, 120, 130, 140]
              },
              {
                "name": "Naples, Italy",
                "lat": 40.8518,
                "lng": 14.2681,
                "temp": [9, 10, 12, 15, 19, 23, 26, 26, 23, 18, 14, 10],
                "precip": [90, 80, 70, 50, 30, 20, 10, 20, 60, 100, 120, 100]
              },
              {
                "name": "Palermo, Italy",
                "lat": 38.1157,
                "lng": 13.3613,
                "temp": [12, 12, 14, 17, 20, 24, 27, 27, 24, 20, 16, 13],
                "precip": [70, 60, 50, 40, 20, 10, 5, 10, 40, 80, 90, 80]
              },
              {
                "name": "Dubrovnik, Croatia",
                "lat": 42.6507,
                "lng": 18.0944,
                "temp": [9, 9, 11, 14, 18, 22, 25, 25, 22, 18, 14, 10],
                "precip": [100, 90, 80, 60, 40, 30, 20, 30, 60, 100, 120, 110]
              },
              {
                "name": "Split, Croatia",
                "lat": 43.5081,
                "lng": 16.4402,
                "temp": [8, 9, 11, 15, 19, 23, 26, 26, 22, 18, 13, 10],
                "precip": [80, 70, 60, 50, 40, 30, 20, 30, 60, 90, 100, 90]
              },
              {
                "name": "Sofia, Bulgaria",
                "lat": 42.6977,
                "lng": 23.3219,
                "temp": [0, 1, 5, 10, 15, 19, 21, 21, 16, 11, 5, 1],
                "precip": [40, 30, 40, 50, 70, 80, 70, 60, 50, 40, 40, 40]
              },
              {
                "name": "Bucharest, Romania",
                "lat": 44.4268,
                "lng": 26.1025,
                "temp": [-1, 1, 6, 12, 17, 21, 23, 22, 17, 12, 6, 1],
                "precip": [30, 30, 30, 40, 60, 70, 60, 50, 40, 40, 40, 30]
              },
              {
                "name": "Kyiv, Ukraine",
                "lat": 50.4501,
                "lng": 30.5234,
                "temp": [-4, -3, 2, 9, 15, 18, 20, 19, 14, 8, 2, -2],
                "precip": [40, 30, 30, 40, 50, 70, 80, 70, 50, 40, 40, 40]
              },
              {
                "name": "Warsaw, Poland",
                "lat": 52.2297,
                "lng": 21.0122,
                "temp": [-2, 0, 4, 9, 15, 18, 20, 19, 14, 9, 4, 0],
                "precip": [30, 30, 30, 40, 50, 70, 80, 70, 50, 40, 40, 40]
              },
              {
                "name": "Minsk, Belarus",
                "lat": 53.9045,
                "lng": 27.5615,
                "temp": [-4, -3, 1, 8, 14, 17, 19, 18, 13, 7, 2, -2],
                "precip": [40, 30, 30, 40, 50, 70, 80, 70, 50, 40, 40, 40]
              },
              {
                "name": "St. Petersburg, Russia",
                "lat": 59.9343,
                "lng": 30.3351,
                "temp": [-6, -6, -2, 4, 10, 15, 18, 16, 11, 6, 1, -3],
                "precip": [40, 30, 30, 30, 40, 60, 70, 70, 60, 60, 50, 50]
              },
              {
                "name": "Novosibirsk, Russia",
                "lat": 55.0084,
                "lng": 82.9357,
                "temp": [-17, -15, -8, 2, 12, 18, 20, 17, 10, 2, -8, -15],
                "precip": [20, 15, 15, 20, 30, 40, 50, 40, 30, 25, 20, 20]
              },
              {
                "name": "Vladivostok, Russia",
                "lat": 43.1182,
                "lng": 131.8867,
                "temp": [-12, -9, -2, 5, 10, 14, 18, 20, 16, 9, -1, -9],
                "precip": [10, 10, 20, 40, 60, 80, 100, 150, 100, 50, 20, 10]
              },
              {
                "name": "Seoul, South Korea",
                "lat": 37.5665,
                "lng": 126.9780,
                "temp": [-2, 0, 5, 12, 17, 22, 25, 26, 21, 14, 7, 0],
                "precip": [20, 20, 40, 60, 100, 150, 300, 300, 150, 50, 40, 20]
              },
              {
                "name": "Shanghai, China",
                "lat": 31.2304,
                "lng": 121.4737,
                "temp": [4, 5, 9, 15, 20, 24, 28, 28, 24, 19, 13, 7],
                "precip": [50, 60, 80, 90, 100, 160, 150, 140, 100, 60, 50, 40]
              },
              {
                "name": "Hong Kong, China",
                "lat": 22.3193,
                "lng": 114.1694,
                "temp": [18, 18, 21, 24, 27, 28, 29, 28, 27, 25, 22, 19],
                "precip": [30, 40, 70, 140, 300, 400, 400, 350, 250, 100, 40, 30]
              },
              {
                "name": "Taipei, Taiwan",
                "lat": 25.0330,
                "lng": 121.5654,
                "temp": [16, 16, 18, 22, 25, 27, 29, 28, 27, 24, 21, 18],
                "precip": [100, 100, 150, 150, 200, 250, 200, 250, 200, 100, 80, 80]
              },
              {
                "name": "Ho Chi Minh City, Vietnam",
                "lat": 10.8231,
                "lng": 106.6297,
                "temp": [27, 28, 29, 30, 29, 28, 27, 27, 27, 27, 27, 26],
                "precip": [10, 10, 20, 50, 200, 300, 300, 250, 300, 250, 100, 50]
              },
              {
                "name": "Phnom Penh, Cambodia",
                "lat": 11.5564,
                "lng": 104.9167,
                "temp": [27, 28, 29, 30, 29, 28, 27, 27, 27, 27, 27, 26],
                "precip": [10, 10, 20, 50, 200, 300, 300, 250, 300, 250, 100, 50]
              },
              {
                "name": "Yangon, Myanmar",
                "lat": 16.8067,
                "lng": 96.1567,
                "temp": [25, 27, 29, 30, 29, 27, 26, 26, 27, 27, 26, 25],
                "precip": [10, 10, 20, 50, 300, 500, 600, 500, 300, 100, 50, 20]
              },
              {
                "name": "Dhaka, Bangladesh",
                "lat": 23.8103,
                "lng": 90.4125,
                "temp": [20, 23, 27, 30, 29, 28, 27, 27, 27, 26, 24, 21],
                "precip": [10, 20, 50, 100, 200, 300, 350, 300, 200, 100, 50, 10]
              },
              {
                "name": "Kathmandu, Nepal",
                "lat": 27.7172,
                "lng": 85.3240,
                "temp": [10, 12, 17, 21, 23, 24, 24, 24, 23, 20, 15, 11],
                "precip": [10, 10, 20, 30, 80, 200, 300, 250, 150, 50, 10, 5]
              },
              {
                "name": "Colombo, Sri Lanka",
                "lat": 6.9271,
                "lng": 79.8612,
                "temp": [27, 27, 28, 28, 28, 27, 27, 27, 27, 27, 27, 27],
                "precip": [100, 70, 100, 200, 300, 200, 100, 100, 200, 300, 200, 150]
              },
              {
                "name": "Male, Maldives",
                "lat": 4.1755,
                "lng": 73.5093,
                "temp": [27, 28, 28, 29, 29, 28, 28, 28, 28, 28, 28, 27],
                "precip": [100, 70, 70, 120, 200, 180, 150, 150, 200, 250, 200, 150]
              },
              {
                "name": "Wuhan, China",
                "lat": 30.5928,
                "lng": 114.3055,
                "temp": [4, 6, 11, 17, 22, 26, 29, 28, 24, 18, 12, 6],
                "precip": [40, 60, 90, 130, 170, 230, 220, 150, 80, 50, 40, 30]
              },
              {
                "name": "Chengdu, China",
                "lat": 30.5728,
                "lng": 104.0668,
                "temp": [6, 8, 12, 17, 21, 23, 25, 25, 21, 17, 12, 8],
                "precip": [10, 20, 40, 70, 100, 120, 200, 180, 120, 50, 20, 10]
              },
              {
                "name": "Chongqing, China",
                "lat": 29.4241,
                "lng": 106.5033,
                "temp": [8, 10, 14, 19, 23, 26, 29, 29, 25, 20, 15, 10],
                "precip": [20, 30, 60, 100, 150, 200, 180, 150, 100, 60, 40, 20]
              },
              {
                "name": "Kunming, China",
                "lat": 25.0406,
                "lng": 102.7100,
                "temp": [9, 11, 14, 17, 19, 20, 20, 20, 19, 17, 13, 10],
                "precip": [10, 10, 20, 30, 80, 150, 200, 200, 120, 50, 20, 10]
              },
              {
                "name": "Ulaanbaatar, Mongolia",
                "lat": 47.9212,
                "lng": 106.9186,
                "temp": [-22, -17, -9, 0, 9, 16, 18, 16, 9, 0, -11, -20],
                "precip": [0, 0, 0, 10, 20, 40, 60, 50, 30, 10, 0, 0]
              },
              {
                "name": "Astana, Kazakhstan",
                "lat": 51.1694,
                "lng": 71.4491,
                "temp": [-14, -14, -8, 4, 14, 20, 22, 19, 13, 4, -5, -12],
                "precip": [20, 15, 15, 20, 30, 40, 50, 40, 30, 25, 20, 20]
              },
              {
                "name": "Tashkent, Uzbekistan",
                "lat": 41.2995,
                "lng": 69.2401,
                "temp": [1, 3, 9, 16, 22, 27, 29, 27, 22, 15, 9, 3],
                "precip": [50, 50, 60, 50, 30, 10, 5, 5, 10, 30, 40, 50]
              },
              {
                "name": "Baku, Azerbaijan",
                "lat": 40.4093,
                "lng": 49.8671,
                "temp": [4, 4, 7, 12, 17, 22, 25, 25, 21, 16, 11, 7],
                "precip": [20, 20, 20, 20, 20, 10, 5, 5, 10, 20, 30, 20]
              },
              {
                "name": "Amman, Jordan",
                "lat": 31.9454,
                "lng": 35.9284,
                "temp": [8, 9, 12, 16, 20, 23, 25, 25, 23, 20, 15, 10],
                "precip": [60, 50, 40, 10, 5, 0, 0, 0, 0, 10, 30, 50]
              },
              {
                "name": "Beirut, Lebanon",
                "lat": 33.8938,
                "lng": 35.5018,
                "temp": [13, 13, 15, 18, 22, 25, 27, 27, 26, 23, 19, 15],
                "precip": [190, 150, 100, 50, 20, 5, 0, 0, 10, 60, 120, 180]
              },
              {
                "name": "Damascus, Syria",
                "lat": 33.5130,
                "lng": 36.2913,
                "temp": [7, 9, 12, 17, 22, 26, 28, 28, 25, 20, 14, 9],
                "precip": [20, 20, 10, 5, 0, 0, 0, 0, 0, 5, 10, 20]
              },
              {
                "name": "Kuwait City, Kuwait",
                "lat": 29.3759,
                "lng": 47.9774,
                "temp": [14, 16, 21, 27, 33, 36, 38, 37, 34, 29, 22, 17],
                "precip": [20, 10, 10, 5, 0, 0, 0, 0, 0, 5, 10, 20]
              },
              {
                "name": "Doha, Qatar",
                "lat": 25.2854,
                "lng": 51.5310,
                "temp": [19, 20, 24, 28, 33, 35, 36, 36, 33, 30, 25, 21],
                "precip": [10, 5, 5, 0, 0, 0, 0, 0, 0, 0, 5, 10]
              },
              {
                "name": "Abu Dhabi, UAE",
                "lat": 24.4539,
                "lng": 54.3773,
                "temp": [19, 21, 24, 28, 33, 35, 36, 36, 33, 30, 25, 21],
                "precip": [10, 5, 5, 0, 0, 0, 0, 0, 0, 0, 5, 10]
              },
              {
                "name": "Muscat, Oman",
                "lat": 23.5859,
                "lng": 58.4059,
                "temp": [21, 22, 26, 30, 34, 36, 36, 35, 33, 30, 26, 22],
                "precip": [10, 10, 10, 5, 0, 0, 0, 0, 0, 0, 5, 10]
              },
              {
                "name": "Sana'a, Yemen",
                "lat": 15.3694,
                "lng": 44.1910,
                "temp": [14, 16, 19, 21, 23, 23, 22, 22, 21, 19, 16, 14],
                "precip": [10, 10, 20, 30, 50, 70, 100, 100, 50, 20, 10, 5]
              },
              {
                "name": "Addis Ababa, Ethiopia",
                "lat": 9.0192,
                "lng": 38.7525,
                "temp": [20, 21, 22, 22, 22, 20, 19, 19, 20, 20, 20, 20],
                "precip": [20, 30, 60, 90, 90, 120, 200, 200, 100, 40, 20, 10]
              },
              {
                "name": "Nairobi, Kenya",
                "lat": -1.2921,
                "lng": 36.8219,
                "temp": [19, 20, 21, 21, 20, 19, 18, 18, 19, 20, 20, 19],
                "precip": [60, 50, 100, 200, 150, 50, 20, 20, 30, 60, 120, 90]
              },
              {
                "name": "Dar es Salaam, Tanzania",
                "lat": -6.7924,
                "lng": 39.2083,
                "temp": [28, 28, 28, 27, 26, 25, 24, 24, 25, 26, 27, 28],
                "precip": [70, 60, 100, 200, 150, 30, 20, 20, 30, 80, 100, 80]
              },
              {
                "name": "Maputo, Mozambique",
                "lat": -25.9653,
                "lng": 32.5892,
                "temp": [27, 27, 26, 24, 22, 20, 19, 20, 22, 23, 25, 26],
                "precip": [100, 80, 70, 40, 20, 10, 10, 10, 20, 50, 80, 100]
              },
              {
                "name": "Luanda, Angola",
                "lat": -8.8383,
                "lng": 13.2344,
                "temp": [27, 28, 28, 28, 26, 24, 23, 23, 24, 26, 27, 27],
                "precip": [30, 40, 70, 100, 50, 0, 0, 0, 10, 30, 70, 50]
              },
              {
                "name": "Kinshasa, DR Congo",
                "lat": -4.4419,
                "lng": 15.2663,
                "temp": [27, 27, 28, 28, 27, 26, 25, 26, 27, 27, 27, 27],
                "precip": [130, 140, 170, 180, 130, 50, 20, 50, 100, 150, 200, 150]
              },
              {
                "name": "Abidjan, Ivory Coast",
                "lat": 5.3600,
                "lng": -4.0083,
                "temp": [27, 28, 28, 28, 27, 26, 25, 25, 26, 27, 27, 27],
                "precip": [40, 50, 100, 150, 200, 300, 100, 50, 100, 150, 100, 50]
              },
              {
                "name": "Accra, Ghana",
                "lat": 5.6037,
                "lng": -0.1870,
                "temp": [28, 28, 29, 29, 28, 26, 25, 25, 26, 27, 28, 28],
                "precip": [20, 40, 80, 100, 150, 200, 100, 50, 100, 100, 50, 20]
              },
              {
                "name": "Dakar, Senegal",
                "lat": 14.7167,
                "lng": -17.4677,
                "temp": [22, 22, 23, 23, 24, 26, 28, 28, 28, 28, 26, 24],
                "precip": [0, 0, 0, 0, 0, 10, 100, 250, 250, 70, 10, 0]
              },
              {
                "name": "Freetown, Sierra Leone",
                "lat": 8.4840,
                "lng": -13.2299,
                "temp": [26, 27, 28, 28, 28, 26, 25, 25, 26, 27, 27, 26],
                "precip": [10, 10, 20, 50, 200, 400, 800, 900, 600, 200, 50, 10]
              },
              {
                "name": "Monrovia, Liberia",
                "lat": 6.3000,
                "lng": -10.8000,
                "temp": [26, 27, 28, 28, 28, 26, 25, 25, 26, 27, 27, 26],
                "precip": [20, 20, 50, 100, 300, 500, 900, 1000, 700, 300, 100, 50]
              },
              {
                "name": "Bamako, Mali",
                "lat": 12.6392,
                "lng": -7.9999,
                "temp": [26, 29, 31, 32, 31, 29, 27, 26, 27, 28, 28, 26],
                "precip": [0, 0, 0, 10, 50, 100, 200, 250, 150, 50, 10, 0]
              },
              {
                "name": "Niamey, Niger",
                "lat": 13.5116,
                "lng": 2.1267,
                "temp": [26, 29, 32, 35, 34, 31, 28, 27, 28, 30, 29, 27],
                "precip": [0, 0, 0, 0, 20, 50, 150, 200, 100, 20, 0, 0]
              },
              {
                "name": "Khartoum, Sudan",
                "lat": 15.5000,
                "lng": 32.5500,
                "temp": [23, 25, 29, 33, 36, 36, 33, 32, 33, 31, 27, 24],
                "precip": [0, 0, 0, 0, 0, 10, 50, 70, 30, 0, 0, 0]
              },
              {
                "name": "Asmara, Eritrea",
                "lat": 15.3229,
                "lng": 38.9250,
                "temp": [17, 18, 20, 21, 21, 20, 18, 18, 19, 19, 18, 17],
                "precip": [0, 0, 0, 10, 20, 30, 100, 100, 30, 10, 0, 0]
              },
              {
                "name": "Djibouti City, Djibouti",
                "lat": 11.8251,
                "lng": 42.5903,
                "temp": [26, 27, 29, 31, 33, 35, 36, 35, 33, 30, 28, 26],
                "precip": [10, 10, 10, 10, 5, 0, 0, 0, 0, 5, 10, 10]
              },
              {
                "name": "Mogadishu, Somalia",
                "lat": 2.0371,
                "lng": 45.3438,
                "temp": [27, 27, 28, 29, 28, 27, 26, 26, 26, 27, 27, 27],
                "precip": [0, 0, 0, 0, 50, 80, 50, 30, 50, 50, 20, 0]
              },
              {
                "name": "Tripoli, Libya",
                "lat": 32.8872,
                "lng": 13.1913,
                "temp": [12, 13, 15, 18, 21, 24, 27, 27, 25, 22, 17, 13],
                "precip": [60, 40, 30, 10, 5, 0, 0, 0, 10, 30, 50, 70]
              },
              {
                "name": "Tunis, Tunisia",
                "lat": 36.8065,
                "lng": 10.1815,
                "temp": [12, 13, 15, 18, 22, 26, 29, 29, 26, 22, 17, 13],
                "precip": [60, 50, 40, 30, 20, 10, 0, 0, 10, 40, 60, 70]
              },
              {
                "name": "Rabat, Morocco",
                "lat": 34.0209,
                "lng": -6.8416,
                "temp": [13, 14, 16, 17, 19, 22, 24, 25, 23, 20, 16, 14],
                "precip": [80, 70, 60, 40, 20, 5, 0, 0, 10, 40, 70, 90]
              },
              {
                "name": "Nouakchott, Mauritania",
                "lat": 18.0735,
                "lng": -15.9582,
                "temp": [21, 23, 25, 26, 28, 29, 29, 29, 29, 28, 25, 22],
                "precip": [0, 0, 0, 0, 0, 0, 20, 50, 30, 10, 0, 0]
              },
              {
                "name": "Antananarivo, Madagascar",
                "lat": -18.8792,
                "lng": 47.5079,
                "temp": [21, 21, 20, 19, 17, 15, 14, 15, 17, 19, 20, 21],
                "precip": [250, 200, 150, 50, 20, 10, 10, 10, 20, 50, 100, 200]
              },
              {
                "name": "Port Louis, Mauritius",
                "lat": -20.1619,
                "lng": 57.4984,
                "temp": [26, 26, 26, 25, 23, 22, 21, 21, 22, 23, 24, 25],
                "precip": [250, 200, 150, 100, 80, 70, 70, 70, 70, 80, 100, 150]
              },
              {
                "name": "Victoria, Seychelles",
                "lat": -4.6191,
                "lng": 55.4513,
                "temp": [27, 28, 28, 28, 28, 27, 26, 26, 27, 27, 27, 27],
                "precip": [250, 200, 150, 100, 80, 70, 70, 70, 70, 80, 100, 150]
              },
              {
                "name": "Canberra, Australia",
                "lat": -35.2809,
                "lng": 149.1300,
                "temp": [20, 20, 17, 14, 10, 8, 7, 8, 11, 14, 17, 19],
                "precip": [50, 50, 50, 40, 40, 40, 40, 50, 50, 60, 60, 50]
              },
              {
                "name": "Brisbane, Australia",
                "lat": -27.4698,
                "lng": 153.0251,
                "temp": [25, 25, 24, 22, 19, 17, 16, 17, 19, 21, 23, 24],
                "precip": [100, 120, 150, 90, 80, 60, 50, 40, 50, 70, 80, 90]
              },
              {
                "name": "Darwin, Australia",
                "lat": -12.4634,
                "lng": 130.8456,
                "temp": [28, 28, 28, 28, 27, 26, 26, 27, 28, 29, 29, 28],
                "precip": [400, 350, 250, 100, 20, 0, 0, 0, 10, 50, 150, 250]
              },
              {
                "name": "Alice Springs, Australia",
                "lat": -23.6980,
                "lng": 133.8807,
                "temp": [32, 31, 28, 23, 18, 15, 14, 17, 22, 27, 30, 31],
                "precip": [30, 30, 20, 10, 10, 10, 10, 10, 10, 20, 20, 30]
              },
              {
                "name": "Christchurch, New Zealand",
                "lat": -43.5321,
                "lng": 172.6362,
                "temp": [17, 17, 15, 12, 9, 7, 6, 8, 10, 12, 14, 16],
                "precip": [50, 40, 50, 50, 60, 60, 60, 50, 40, 40, 40, 50]
              },
              {
                "name": "Queenstown, New Zealand",
                "lat": -45.0312,
                "lng": 168.6626,
                "temp": [16, 16, 14, 11, 8, 5, 4, 6, 9, 11, 13, 15],
                "precip": [70, 60, 70, 80, 90, 90, 80, 80, 80, 80, 70, 70]
              },
              {
                "name": "Suva, Fiji",
                "lat": -18.1248,
                "lng": 178.4501,
                "temp": [26, 26, 26, 25, 24, 23, 23, 23, 24, 25, 26, 26],
                "precip": [280, 270, 290, 280, 250, 180, 150, 170, 200, 250, 280, 290]
              },
              {
                "name": "Port Moresby, Papua New Guinea",
                "lat": -9.4438,
                "lng": 147.1797,
                "temp": [27, 27, 27, 27, 27, 26, 26, 26, 26, 27, 27, 27],
                "precip": [180, 190, 170, 100, 50, 20, 10, 10, 20, 50, 100, 150]
              },
              {
                "name": "Honolulu, USA",
                "lat": 21.3099,
                "lng": -157.8583,
                "temp": [23, 23, 24, 25, 26, 27, 28, 28, 27, 26, 25, 24],
                "precip": [90, 60, 50, 30, 20, 10, 10, 10, 20, 40, 70, 90]
              },
              {
                "name": "Anchorage, USA",
                "lat": 61.2181,
                "lng": -149.9003,
                "temp": [-8, -6, -3, 2, 8, 12, 15, 14, 9, 1, -5, -8],
                "precip": [20, 20, 20, 15, 20, 30, 40, 50, 60, 50, 30, 30]
              },
              {
                "name": "Fairbanks, USA",
                "lat": 64.8378,
                "lng": -147.7164,
                "temp": [-22, -18, -10, 1, 10, 17, 19, 16, 8, -3, -15, -20],
                "precip": [10, 10, 10, 10, 15, 20, 40, 40, 20, 15, 10, 10]
              },
              {
                "name": "Juneau, USA",
                "lat": 58.3019,
                "lng": -134.4197,
                "temp": [-2, -1, 1, 5, 9, 12, 14, 13, 10, 6, 2, -1],
                "precip": [120, 100, 90, 80, 80, 80, 100, 120, 150, 200, 180, 150]
              },
              {
                "name": "Yellowknife, Canada",
                "lat": 62.4540,
                "lng": -114.3718,
                "temp": [-26, -22, -16, -4, 6, 14, 17, 14, 7, -2, -15, -23],
                "precip": [10, 10, 10, 10, 20, 30, 40, 40, 30, 20, 10, 10]
              },
              {
                "name": "Iqaluit, Canada",
                "lat": 63.7467,
                "lng": -68.5170,
                "temp": [-23, -24, -20, -11, -2, 4, 8, 7, 2, -4, -11, -19],
                "precip": [20, 15, 20, 20, 20, 30, 40, 50, 40, 30, 20, 20]
              },
              {
                "name": "Saskatoon, Canada",
                "lat": 52.1332,
                "lng": -106.6700,
                "temp": [-17, -14, -7, 3, 10, 16, 19, 17, 10, 2, -8, -15],
                "precip": [10, 10, 10, 20, 30, 60, 70, 60, 40, 20, 10, 10]
              },
              {
                "name": "Winnipeg, Canada",
                "lat": 49.8951,
                "lng": -97.1384,
                "temp": [-18, -15, -8, 2, 10, 16, 19, 18, 11, 3, -7, -15],
                "precip": [20, 20, 20, 30, 50, 80, 70, 70, 50, 30, 20, 20]
              },
              {
                "name": "Regina, Canada",
                "lat": 50.4452,
                "lng": -104.6189,
                "temp": [-17, -14, -7, 3, 10, 16, 19, 17, 10, 2, -8, -15],
                "precip": [10, 10, 10, 20, 30, 60, 70, 60, 40, 20, 10, 10]
              },
              {
                "name": "Quebec City, Canada",
                "lat": 46.8139,
                "lng": -71.2080,
                "temp": [-11, -9, -3, 4, 11, 16, 19, 18, 13, 7, 0, -8],
                "precip": [80, 70, 70, 80, 90, 100, 120, 110, 100, 90, 90, 80]
              },
              {
                "name": "Halifax, Canada",
                "lat": 44.6488,
                "lng": -63.5752,
                "temp": [-4, -3, 0, 5, 10, 15, 19, 19, 15, 10, 5, 0],
                "precip": [150, 130, 140, 130, 120, 100, 90, 90, 100, 120, 140, 150]
              },
              {
                "name": "St. John's, Canada",
                "lat": 47.5615,
                "lng": -52.7126,
                "temp": [-4, -4, -1, 3, 7, 12, 16, 16, 12, 8, 3, -1],
                "precip": [150, 130, 140, 130, 120, 100, 90, 90, 100, 120, 140, 150]
              },
              {
                "name": "Mexico City, Mexico",
                "lat": 19.4326,
                "lng": -99.1332,
                "temp": [13, 14, 17, 18, 19, 18, 17, 17, 17, 16, 15, 14],
                "precip": [10, 10, 10, 30, 70, 150, 170, 160, 120, 40, 10, 10]
              },
              {
                "name": "Guadalajara, Mexico",
                "lat": 20.6597,
                "lng": -103.3496,
                "temp": [18, 19, 21, 23, 24, 23, 22, 22, 22, 21, 20, 18],
                "precip": [10, 0, 0, 10, 50, 200, 250, 200, 150, 50, 10, 10]
              },
              {
                "name": "Monterrey, Mexico",
                "lat": 25.6866,
                "lng": -100.3161,
                "temp": [14, 16, 20, 24, 27, 29, 29, 29, 26, 22, 18, 15],
                "precip": [20, 20, 20, 30, 50, 80, 100, 100, 150, 80, 30, 20]
              },
              {
                "name": "Cancun, Mexico",
                "lat": 21.1619,
                "lng": -86.8515,
                "temp": [23, 24, 25, 27, 28, 28, 28, 28, 28, 27, 25, 24],
                "precip": [100, 50, 50, 50, 100, 150, 100, 100, 200, 250, 150, 100]
              },
              {
                "name": "Belize City, Belize",
                "lat": 17.5000,
                "lng": -88.2000,
                "temp": [24, 25, 26, 27, 28, 28, 27, 27, 27, 26, 25, 24],
                "precip": [100, 50, 50, 50, 100, 150, 200, 200, 250, 200, 150, 100]
              },
              {
                "name": "Guatemala City, Guatemala",
                "lat": 14.6349,
                "lng": -90.5069,
                "temp": [18, 19, 21, 22, 22, 21, 20, 20, 20, 20, 19, 18],
                "precip": [10, 10, 20, 50, 150, 250, 200, 200, 250, 150, 50, 10]
              },
              {
                "name": "San Salvador, El Salvador",
                "lat": 13.6929,
                "lng": -89.2182,
                "temp": [22, 23, 24, 25, 25, 24, 24, 24, 24, 23, 23, 22],
                "precip": [10, 10, 20, 50, 200, 250, 200, 200, 250, 150, 50, 10]
              },
              {
                "name": "Tegucigalpa, Honduras",
                "lat": 14.0818,
                "lng": -87.2068,
                "temp": [21, 22, 24, 25, 25, 24, 23, 23, 23, 22, 22, 21],
                "precip": [10, 10, 20, 50, 200, 250, 200, 200, 250, 150, 50, 10]
              },
              {
                "name": "Managua, Nicaragua",
                "lat": 12.1364,
                "lng": -85.1767,
                "temp": [27, 28, 29, 30, 29, 28, 27, 27, 27, 27, 27, 27],
                "precip": [10, 10, 20, 50, 200, 250, 200, 200, 250, 150, 50, 10]
              },
              {
                "name": "San Jose, Costa Rica",
                "lat": 9.9281,
                "lng": -84.0907,
                "temp": [22, 23, 24, 24, 23, 22, 22, 22, 22, 22, 22, 22],
                "precip": [10, 10, 30, 100, 250, 250, 200, 200, 250, 200, 100, 30]
              },
              {
                "name": "Panama City, Panama",
                "lat": 8.9824,
                "lng": -79.5199,
                "temp": [27, 27, 28, 28, 28, 27, 27, 27, 27, 27, 27, 27],
                "precip": [30, 20, 30, 100, 200, 250, 200, 200, 250, 250, 150, 50]
              },
              {
                "name": "Bogota, Colombia",
                "lat": 4.7110,
                "lng": -74.0721,
                "temp": [14, 14, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14],
                "precip": [60, 70, 90, 100, 100, 50, 40, 40, 70, 100, 90, 70]
              },
              {
                "name": "Medellin, Colombia",
                "lat": 6.2442,
                "lng": -75.5696,
                "temp": [22, 22, 23, 23, 23, 22, 22, 22, 22, 22, 22, 22],
                "precip": [80, 80, 100, 120, 150, 120, 100, 100, 120, 150, 120, 100]
              },
              {
                "name": "Cali, Colombia",
                "lat": 3.4516,
                "lng": -76.5320,
                "temp": [24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24],
                "precip": [70, 70, 80, 100, 120, 100, 80, 80, 100, 120, 100, 80]
              },
              {
                "name": "Quito, Ecuador",
                "lat": -0.1807,
                "lng": -78.4678,
                "temp": [14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14],
                "precip": [100, 120, 130, 150, 120, 50, 20, 20, 60, 100, 100, 90]
              },
              {
                "name": "Guayaquil, Ecuador",
                "lat": -2.1883,
                "lng": -79.8756,
                "temp": [27, 28, 28, 28, 27, 26, 25, 25, 26, 26, 27, 27],
                "precip": [200, 250, 200, 100, 50, 10, 0, 0, 10, 50, 100, 150]
              },
              {
                "name": "La Paz, Bolivia",
                "lat": -16.4897,
                "lng": -68.1193,
                "temp": [10, 10, 10, 10, 9, 8, 8, 9, 9, 10, 10, 10],
                "precip": [130, 100, 80, 40, 10, 0, 0, 0, 10, 30, 60, 100]
              },
              {
                "name": "Santa Cruz, Bolivia",
                "lat": -17.7833,
                "lng": -63.1822,
                "temp": [26, 26, 26, 25, 23, 22, 21, 22, 23, 24, 25, 26],
                "precip": [150, 120, 100, 80, 50, 30, 20, 20, 50, 80, 100, 120]
              },
              {
                "name": "Brasilia, Brazil",
                "lat": -15.7801,
                "lng": -47.9292,
                "temp": [22, 22, 22, 22, 21, 20, 20, 21, 22, 22, 22, 22],
                "precip": [200, 180, 150, 100, 50, 10, 0, 0, 50, 150, 200, 200]
              },
              {
                "name": "Salvador, Brazil",
                "lat": -12.9714,
                "lng": -38.5014,
                "temp": [27, 27, 27, 27, 26, 25, 24, 24, 25, 26, 27, 27],
                "precip": [100, 80, 100, 150, 200, 250, 200, 150, 100, 80, 70, 80]
              },
              {
                "name": "Recife, Brazil",
                "lat": -8.0578,
                "lng": -34.8829,
                "temp": [27, 27, 27, 27, 26, 25, 24, 24, 25, 26, 27, 27],
                "precip": [100, 80, 100, 150, 200, 250, 200, 150, 100, 80, 70, 80]
              }
            ]

lobbies_lock = threading.Lock()

users_db = {}

tokens_to_users = {}


def generate_unique_lobby_code(length=6):
    """Generates a unique alphanumeric lobby code."""
    characters = string.ascii_uppercase + string.digits
    while True:
        code = ''.join(random.choice(characters) for i in range(length))
        with lobbies_lock:
            if code not in active_lobbies:
                return code

def calculate_distance(lat1, lon1, lat2, lon2):
    R = 6371
    dLat = math.radians(lat2 - lat1)
    dLon = math.radians(lon2 - lon1)

    a = (math.sin(dLat / 2) * math.sin(dLat / 2) +
         math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) *
         math.sin(dLon / 2) * math.sin(dLon / 2))

    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    distance = R * c
    return distance

def broadcast_lobby_update(lobby_code):
    if lobby_code in active_lobbies:
        socketio.emit('lobby_update', {
            'lobby_code': lobby_code,
            'details': active_lobbies[lobby_code]
        },room=lobby_code)

@socketio.on('start_solo_game')
def handle_start_solo_game():
    socket_id = request.sid
    active_solo_games[socket_id] = {
        'current_round': 1,
        'score': 0,
        'climate': random.choice(climateData)
    }
    emit('solo_game_start_response', {'success': True, 'message': 'Solo game started!', 'climate': active_solo_games[socket_id]['climate']})

@socketio.on('resize_chart')
def handle_resize_chart(data):
    socket_id = request.sid
    if socket_id not in active_solo_games:
        emit('solo_guess_response', {'success': False, 'message': 'No active solo game found.'})
        return
    emit('resize_chart_response', {
        'climate': active_solo_games[socket_id]['climate'],
        'big': data.get('big')
    })

@socketio.on('submit_solo_guess')
def handle_submit_solo_guess(data):
    socket_id = request.sid
    guess_lat = data.get('guessLat')
    guess_lng = data.get('guessLng')

    game_data = active_solo_games[socket_id]
    climate = game_data['climate']
    actual_lat = climate['lat']
    actual_lng = climate['lng']

    lat_distance = abs((guess_lat - actual_lat)) * 111  # approx km per degree latitude
    lon_distance = abs((guess_lng - actual_lng)) * 111  # approx km per degree longitude

    lat_points = 0 if lat_distance > 2500 else round(2500 - lat_distance)
    lon_points = 0 if lon_distance > 2500 else round(2500 - lon_distance)
    points = lat_points + lon_points

    game_data['score'] += points
    emit('solo_guess_response', {
        'success': True,
        'message': f'Round {game_data["current_round"]} started!',
        'current_round': game_data['current_round'],
        "name": climate['name'],
        'score': game_data['score'],
        'actual_location': {'lat': actual_lat, 'lng': actual_lng},
        "total_points": game_data['score'],
        'points_earned': points
    })

@socketio.on("start_solo_round")
def handle_solo_start_round():
    socket_id = request.sid
    if socket_id not in active_solo_games:
        emit('solo_guess_response', {'success': False, 'message': 'No active solo game found.'})
        return
    active_solo_games[socket_id]['current_round'] += 1
    active_solo_games[socket_id]['climate'] = random.choice(climateData)
    emit('solo_round_started', {
        'success': True,
        'message': f'Round {active_solo_games[socket_id]["current_round"]} started!',
        'climate': active_solo_games[socket_id]['climate'],
        "current_round": active_solo_games[socket_id]['current_round'],
        "total_score": active_solo_games[socket_id]['score']
    })

@socketio.on("delete_solo_game")
def handle_delete_solo_game():
    socket_id = request.sid
    if socket_id in active_solo_games:
        del active_solo_games[socket_id]
        emit('solo_game_deleted', {'success': True, 'message': 'Solo game deleted successfully.'})
    else:
        emit('solo_game_deleted', {'success': False, 'message': 'No active solo game found.'})

@socketio.on("save_solo_game")
def handle_save_solo_game(data):
    socket_id = request.sid
    token = data.get('token')
    username = tokens_to_users.get(token)
    if socket_id not in active_solo_games:
        emit('save_solo_response', {'success': False, 'message': 'No active solo game found.'})
        return
    if not username or username not in users_db:
        emit('save_solo_response', {'success': False, 'message': 'Invalid username.'})
        return

    game_data = db_models.leaderboard(username=username, score=active_solo_games[socket_id]['score'],timestamp=datetime.now())
    db.session.add(game_data)
    db.session.commit()
    print(f'Solo game saved for user: {username} with score: {active_solo_games[socket_id]["score"]}')
    emit('save_solo_response', {'success': True, 'message': 'Solo game saved successfully!'})



@socketio.on('get_leaderboard')
def handle_get_leaderboard():
    # Alle Eintrge abfragen, absteigend nach score sortieren
    leaderboard_data = db_models.leaderboard.query.order_by(db_models.leaderboard.score.desc()).all()

    # Die Daten fr den Client formatieren
    leaderboard = [{
        'username': entry.username,
        'score': entry.score,
        'timestamp': entry.timestamp.strftime('%Y-%m-%d %H:%M:%S')
    } for entry in leaderboard_data]

    # Daten an den Client senden
    socketio.emit('leaderboard_update', leaderboard)

@socketio.on('register')
def handle_register(data):
    username = data.get('username')
    password = data.get('password')
    email = data.get('email')

    if not username or not password:
        emit('registration_response', {'success': False, 'message': 'Username and password are required.'})
        return

    if username in users_db:
        emit('registration_response', {'success': False, 'message': 'Username already exists.'})
        return

    hashed_password = generate_password_hash(password)

    users_db[username] = {
        'email': email,
        'password': hashed_password,
    }

    print(f'New user registered: {username}')
    emit('registration_response', {'success': True, 'message': 'Registration successful!'})

@socketio.on('login')
def handle_login(data):
    username = data.get('username')
    password = data.get('password')

    if not username or not password:
        emit('login_response', {'success': False, 'message': 'Username and password are required.'})
        return

    user_data = users_db.get(username)
    if not user_data:
        emit('login_response', {'success': False, 'message': 'Invalid username or password.'})
        return

    if check_password_hash(user_data['password'], password):
        token = str(uuid.uuid4())
        
        users_db[username]['token'] = token
        tokens_to_users[token] = username

        print(f'User logged in: {username} with token: {token}')
        emit('login_response', {'success': True, 'message': 'Login successful!', 'token': token, 'username': username})
    else:
        emit('login_response', {'success': False, 'message': 'Invalid username or password.'})

@socketio.on('authenticate')
def handle_authenticate(data):
    
    token = data.get('token')
    
    username = tokens_to_users.get(token)

    if username:
        emit('auth_response', {
            'success': True,
            'message': f'Welcome, {username}! Your token is valid.',
            'username': username
        })
    else:
        emit('auth_response', {'success': False, 'message': 'Authentication failed. Invalid or expired token.'})

@app.route("/is_lobby_joinable", methods=["POST"])
def is_lobby_joinable():
    data = request.get_json()
    lobby_code = data["lobby_code"]
    with lobbies_lock:
        if lobby_code in active_lobbies and active_lobbies[lobby_code]["status"] == "waiting":
            return jsonify({
                "joinable": True
            })
        else:
            return jsonify({
                "joinable": False
            })
@app.route("/", methods=["GET"])
def index():
    return render_template("index.html")
@app.route("/profile.png", methods=["GET"])
def profile_image():
    return send_from_directory('pictures', 'profile.png')

@app.route("/multiplayerhost", methods=["GET"])
def multiplayerhost():
    return render_template("multiplayerhost.html")

@app.route("/multiplayer", methods=["GET"])
def multiplayer():
    return render_template("multiplayer.html")

@app.route("/singleplayer", methods=["GET"])
def singleplayer():
    return render_template("singleplayer.html")

@app.route("/singleplayerlegacy", methods=["GET"])
def singleplayerlegacy():
    return render_template("singleplayerlegacy.html")
  
@app.route("/settings.png", methods=["GET"])
def settings_image():
    return send_from_directory('pictures', 'settings.png')
@socketio.on('connect')
def handle_connect():
    print(f'Client {request.sid} connected')
    emit('connected', {'message': 'Successfully connected to server'})

@socketio.on('disconnect')
def handle_disconnect():
    print(f'Client {request.sid} disconnected')

@socketio.on('create_lobby')
def handle_create_lobby():
    try:

        new_lobby_code = generate_unique_lobby_code()

        with lobbies_lock:
            active_lobbies[new_lobby_code] = {
                'status': 'waiting',
                'players': {},
                'active_climate': None,
                'round': None
            }
        
        # Join the Socket.IO room for this lobby
        join_room(new_lobby_code)
        print(f"Lobby created: {new_lobby_code}. Total active lobbies: {len(active_lobbies)}")

        emit('lobby_created', {
            'success': True,
            'lobby_code': new_lobby_code,
            'message': 'Lobby created successfully. Share this code with your friends!'
        })

    except Exception as e:
        print(f"Error creating lobby: {e}")
        emit('lobby_created', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })
@socketio.on("register_player")
def reg(data):
    nickname = data.get('nickname', None)
    lobby_code = data.get('lobby_code', None)
    if not lobby_code or not nickname:
        emit('register_result', {
            'error_code': 'missing_fields',
            'success': False,
            'message': "Lobby code and nickname are required."
        })
        return

    if len(nickname) > 10:
        emit('register_result', {
            'success': False,
            'message': "Nickname is too long."
        })
        return

    with lobbies_lock:
        if lobby_code not in active_lobbies:
            emit('register_result', {
                'success': False,
                'error_code': 'lobby_not_found',
                'message': f"Lobby '{lobby_code}' not found."
            })
            return
        if not nickname in active_lobbies[lobby_code]['players'] and not nickname == "Host":
            emit('register_result', {
                'success': False,
                'message': "Nickname doesn't exist in the lobby.",
                'error_code': 'nickname_not_found'
            })
            return
        
    join_room(lobby_code)

    emit('register_result', {
        'success': True,
        'message': "Successfully registered."
    })

@socketio.on('join_lobby')
def handle_join_lobby(data):
    try:
        lobby_code = data['lobby_code'].upper()
        nickname = data['nickname']

        if not lobby_code or not nickname:
            emit('join_result', {
                'success': False,
                'message': "Lobby code and nickname are required."
            })
            return
        if nickname == "":
            emit('join_result', {
                'success': False,
                'message': "Nickname cannot be empty."
            })
            return

        with lobbies_lock:
            if lobby_code not in active_lobbies:
                emit('join_result', {
                    'success': False,
                    'message': f"Lobby '{lobby_code}' not found."
                })
                return

            if len(active_lobbies[lobby_code]['players']) >= 8:
                emit('join_result', {
                    'success': False,
                    'message': "Lobby is full."
                })
                return

            if len(nickname) >= 10:
                emit('join_result', {
                    'success': False,
                    'message': "Nickname is too long."
                })
                return

            if nickname in active_lobbies[lobby_code]['players']:
                emit('join_result', {
                    'success': False,
                    'message': "Nickname already taken."
                })
                return

            # Add player to lobby
            active_lobbies[lobby_code]['players'][nickname] = {
                'nickname': nickname,
                'session_id': request.sid,
                'alreadyguessed': False,
                'guess': None,
                'score': 0
            }

        # Join the Socket.IO room for this lobby
        join_room(lobby_code)
        print(f"Player '{nickname}' joined lobby '{lobby_code}'")
        emit('join_result', {
            'success': True,
            "nickname": nickname,
            'message': f"Successfully joined lobby '{lobby_code}' as {nickname}",
            'lobby_code': lobby_code
        })

        # Broadcast to all players in the lobby that someone joined
        broadcast_lobby_update(lobby_code)

    except Exception as e:
        print(f"Error joining lobby: {e}")
        emit('join_result', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })

@socketio.on('start_lobby')
def handle_start_lobby(data):
    """Handle starting a lobby game"""
    try:
        lobby_code = data['lobby_code'].upper()

        if lobby_code not in active_lobbies:
            emit('start_result', {
                'success': False,
                'message': f"Lobby '{lobby_code}' not found."
            })
            return

        active_lobbies[lobby_code]['status'] = 'playing'
        active_lobbies[lobby_code]['active_climate'] = random.choice(climateData)
        active_lobbies[lobby_code]['round'] = 1

        print(f"Lobby '{lobby_code}' started with climate {active_lobbies[lobby_code]['active_climate']}")

        # Broadcast to all players in the lobby that the game started
        socketio.emit('game_started', {
            'success': True,
            'message': f"Game started in lobby '{lobby_code}'",
            'clima': active_lobbies[lobby_code]['active_climate'],
            'round': active_lobbies[lobby_code]['round']
        }, room=lobby_code)

    except Exception as e:
        print(f"Error starting lobby: {e}")
        emit('start_result', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })

@socketio.on('make_guess')
def handle_guess(data):
    try:
        lobby_code = data['lobby_code'].upper()
        nickname = data['nickname']
        guess = data['guess']

        if lobby_code not in active_lobbies or active_lobbies[lobby_code]['status'] != 'playing':
            emit('guess_result', {
                'success': False,
                'message': f"Lobby '{lobby_code}' not found or not started yet."
            })
            return

        if nickname not in active_lobbies[lobby_code]['players']:
            emit('guess_result', {
                'success': False,
                'message': f"Player '{nickname}' not found in lobby '{lobby_code}'."
            })
            return

        if active_lobbies[lobby_code]['players'][nickname]['alreadyguessed']:
            emit('guess_result', {
                'success': False,
                'message': f"Player '{nickname}' has already guessed."
            })
            return

        # Record the guess
        active_lobbies[lobby_code]['players'][nickname]['alreadyguessed'] = True
        active_lobbies[lobby_code]['players'][nickname]['guess'] = guess

        emit('guess_result', {
            'success': True,
            'message': 'Guess submitted successfully.',
            'guess': guess
        })

        print(f"Player '{nickname}' made a guess: {guess}")

        already_guessed = [p['nickname'] for p in active_lobbies[lobby_code]['players'].values() if p['alreadyguessed']]
        not_guessed = [p['nickname'] for p in active_lobbies[lobby_code]['players'].values() if not p['alreadyguessed']]

        # Broadcast to all players that someone made a guess
        socketio.emit('player_guessed', {
            'already_guessed': already_guessed,
            'not_guessed': not_guessed,
        }, room=lobby_code)

    except Exception as e:
        print(f"Error handling guess: {e}")
        emit('guess_result', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })

@socketio.on('end_round')
def handle_end_round(data):
    """Handle ending a round and calculating scores"""
    try:
        lobby_code = data['lobby_code'].upper()

        if lobby_code not in active_lobbies or active_lobbies[lobby_code]['status'] != 'playing':
            emit('end_result', {
                'success': False,
                'message': f"Lobby '{lobby_code}' not found or not in playing state."
            })
            return

        active_lobbies[lobby_code]['status'] = 'result'

        # Calculate scores for all players
        for player in active_lobbies[lobby_code]['players']:
            if not active_lobbies[lobby_code]['players'][player]['alreadyguessed']:
                continue

            distance = calculate_distance(
                active_lobbies[lobby_code]['active_climate']['lat'],
                active_lobbies[lobby_code]['active_climate']['lng'],
                active_lobbies[lobby_code]['players'][player]['guess']['lat'],
                active_lobbies[lobby_code]['players'][player]['guess']['lng']
            )

            if distance > 5000:
                points = 0
            else:
                points = round(5000 - distance)
            if distance < 300:
                points = 5000
            elif distance < 1500:
                points = round(4000 + (500 - distance) * 2)
            elif distance < 3000:
                points = round(3000 + (1000 - distance))

            active_lobbies[lobby_code]['players'][player]['score'] += points

        # Broadcast results to all players
        socketio.emit('round_ended', {
            'success': True,
            'message': f"Round ended in lobby '{lobby_code}'",
            'details': active_lobbies[lobby_code],
            'actual_location_lat': active_lobbies[lobby_code]['active_climate']['lat'],
            'actual_location_lng': active_lobbies[lobby_code]['active_climate']['lng']
        }, room=lobby_code)

    except Exception as e:
        print(f"Error ending round: {e}")
        emit('end_result', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })

@socketio.on('start_new_round')
def handle_start_new_round(data):
    try:
        lobby_code = data['lobby_code'].upper()

        if lobby_code not in active_lobbies or active_lobbies[lobby_code]['status'] != 'result':
            emit('new_round_result', {
                'success': False,
                'message': f"Lobby '{lobby_code}' not found or not in result state."
            })
            return

        active_lobbies[lobby_code]['status'] = 'playing'
        active_lobbies[lobby_code]['active_climate'] = random.choice(climateData)
        active_lobbies[lobby_code]['round'] += 1

        # Reset player guesses
        for nickname in active_lobbies[lobby_code]['players']:
            active_lobbies[lobby_code]['players'][nickname]['alreadyguessed'] = False
            active_lobbies[lobby_code]['players'][nickname]['guess'] = None

        # Broadcast new round to all players
        socketio.emit('new_round_started', {
            'success': True,
            'all_players': list(active_lobbies[lobby_code]['players'].keys()),
            'message': 'New round started!',
            'active_climate': active_lobbies[lobby_code]['active_climate'],
            'round': active_lobbies[lobby_code]['round']
        }, room=lobby_code)

    except Exception as e:
        print(f"Error starting new round: {e}")
        emit('new_round_result', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })
@socketio.on('end_game')
def handle_end_game(data):
    try:
        lobby_code = data['lobby_code'].upper()

        if lobby_code not in active_lobbies or active_lobbies[lobby_code]['status'] != 'result':
            emit('end_game_result', {
                'success': False,
                'message': f"Lobby '{lobby_code}' not found or not in result state."
            })
            return

        # Reset the lobby
        with lobbies_lock:
            del active_lobbies[lobby_code]

        print(f"Game ended and lobby '{lobby_code}' deleted.")

        emit('end_game', {
            'lobby_code': lobby_code,
            'message': f"Game ended and lobby '{lobby_code}' deleted."
        }, room=lobby_code)

        emit('end_game_result', {
            'success': True,
            'message': f"Game ended and lobby '{lobby_code}' deleted."
        })

    except Exception as e:
        print(f"Error ending game: {e}")
        emit('end_game_result', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })
@socketio.on('get_lobby_info')
def handle_get_lobby_info(data):
    if not data:
        emit('lobby_info', {
            'success': False,
            'message': "No data provided."
        })
        return
    if 'lobby_code' not in data:
        emit('lobby_info', {
            'success': False,
            'message': "Lobby code is required."
        })
        return
    try:
        lobby_code = data['lobby_code'].upper()

        with lobbies_lock:
            lobby = active_lobbies.get(lobby_code)

        if lobby:
            emit('lobby_info', {
                'success': True,
                'lobby_code': lobby_code,
                'details': lobby,
                'all_players': list(lobby['players'].keys())
            })
        else:
            emit('lobby_info', {
                'success': False,
                'message': f"Lobby '{lobby_code}' not found."
            })

    except Exception as e:
        print(f"Error getting lobby info: {e}")
        emit('lobby_info', {
            'success': False,
            'message': f'An error occurred: {str(e)}'
        })

if __name__ == '__main__':
    socketio.run(app,debug=True, port=8081)